# Техническое задание: Упрощённая модель PGW (Packet Gateway)

## 1. Цель проекта

Разработать упрощённую модель сетевого компонента **PGW**, способную:

- Обрабатывать **UDP-запросы**.
- Управлять сессиями абонентов по **IMSI**.
- Вести **CDR-журнал**.
- Предоставлять **HTTP API**.
- Поддерживать **чёрный список IMSI**.
- Корректно завершать работу.

---

## 2. Архитектура решения

### Основное приложение: `pgw_server`

- Приём **UDP пакетов**, содержащих IMSI.
- Создание сессии, если IMSI **не в чёрном списке** и сессия не существует.
- Отправка ответа: **`created`** или **`rejected`**.
- Запись CDR (**IMSI, действие, время**) в файл.
- Удаление сессии по таймеру с записью CDR.
- Чтение настроек из **JSON-конфига**:  
  - порты  
  - таймаут  
  - лимит offload  
  - чёрный список  
  - и другие параметры  
- HTTP API:
  - `/check_subscriber`
  - `/stop`
- Логирование всех ключевых действий.
- Поддержка **чёрного списка IMSI** с отклонением запросов.

### Тестовое приложение: `pgw_client`

- Запуск из командной строки с IMSI.
- Чтение настроек из JSON.
- Отправка **UDP-пакета** с IMSI и получение ответа.
- Вывод текста ответа.
- Логирование отправки, ответа и ошибок.

---

## 3. Формат данных

- **UDP-запрос**: строка IMSI в **BCD-кодировке** (TS 29.274 §8.3).
- **UDP-ответ**: ASCII-строка  
  - `created`  
  - `rejected`  
- **CDR**: строка в формате: timestamp, IMSI, action

---

## 4. Формат конфигурационного файла

### Пример `pgw_server`

```json
{
"udp_ip": "0.0.0.0",
"udp_port": 9000,
"session_timeout_sec": 30,
"cdr_file": "cdr.log",
"http_port": 8080,
"graceful_shutdown_rate": 10,
"log_file": "pgw.log",
"log_level": "INFO",
"blacklist": [
  "001010123456789",
  "001010000000001"
]
}
```

### Пример `pgw_client`

```json
{
  "server_ip": "127.0.0.1",
  "server_port": 9000,
  "log_file": "client.log",
  "log_level": "INFO"
}
```

---

## 5. Формат запросов HTTP API

- Команда `/check_subscriber` проверяет, существует ли сессия с заданным IMSI, и возвращает ответ в виде текста `active` или `not active`.
- Команда `/stop` завершает работу приложения, используя механизм graceful offload: сессии удаляются с заданной скоростью, происходит запись CDR.

---

## 6. Технические требования

- Основной код должен быть написан на С++, в качестве вспомогательного языка или средства допускаются Lua, Python, Perl, Node.js, shell (bash, sh, etc).
- Исходный код должен быть размещен в открытых репозиториях (github, gitlab - на выбор). 
- Для сборки использовать cmake. Все сторонние библиотеки должны скачиваться в cmake файле. Использование предустановленных библиотек в системе (исключая системных уровня glib, libc и т.д) не допускается.
- Сборка должна выполняться под Linux.
- Использование новых стандартов приветствуется.
- Наличие unit-тестов обязательно. Лучше использовать googletest, любая другая библиотека не запрещается. Степень покрытия кода unit-тестами выбирайте самостоятельно.
- Дополнительным плюсом будет документация с описанием проекта.
- Дополнительным плюсом будет наличие UML диаграмм.
- Использование JSON-библиотеки (например, nlohmann::json, rapidjson и другие).
- HTTP: cpp-httplib, Boost.Beast, Crow и т.п.
- Сокеты: Сокеты Беркли, сторонние библиотеки для реализации UDP сокета запрещаются.
- Конфигурация из JSON.
- Поддержка чёрного списка IMSI.
- Обязательно использование логирования в коде, с уровнями debug, info, warn, critical, error. Библиотеку для логирования можно выбрать по своему усмотрению, обзор логгеров тут [статья на habr.com]([habr](https://habr.com/ru/post/313686/))
- CDR-запись в файл.
- Многопоточность — по желанию.
